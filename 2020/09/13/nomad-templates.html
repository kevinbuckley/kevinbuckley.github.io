<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="https://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      using python and jinja2 for templating Hashicorp Nomad job files &middot; kevin buckley
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        kevin buckley
      </a>
    </div>
    <p class="lead">things I learn in tech</p>
  </header>
  <nav id="sidebar-nav-links">
  
  

  

  


  

  
    
      <a class="page-link "
          href="/">kevin buckley blog</a>
    
  

  

  
    
      <a class="page-link "
          href="/me.html">me</a>
    
  

  


  


  

  
    
  

  

  
    
  

  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  

  <nav id="sidebar-icon-links">
  

  <a id="subscribe-link"
     class="icon" title="Subscribe" aria-label="Subscribe"
     href="/feed.xml">
    <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <circle cx="6.18" cy="17.82" r="2.18"/>
    <path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/>
</svg>
  </a>

  
  
  
  

  

  

  <a id="github-link" target="_black"
class="icon" title="Github Project" aria-label="Github Project"
href="https://github.com/kevinbuckley">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 28" height="24" width="28"><path d="M12 2c6.625 0 12 5.375 12 12 0 5.297-3.437 9.797-8.203 11.391-0.609 0.109-0.828-0.266-0.828-0.578 0-0.391 0.016-1.687 0.016-3.297 0-1.125-0.375-1.844-0.812-2.219 2.672-0.297 5.484-1.313 5.484-5.922 0-1.313-0.469-2.375-1.234-3.219 0.125-0.313 0.531-1.531-0.125-3.187-1-0.313-3.297 1.234-3.297 1.234-0.953-0.266-1.984-0.406-3-0.406s-2.047 0.141-3 0.406c0 0-2.297-1.547-3.297-1.234-0.656 1.656-0.25 2.875-0.125 3.187-0.766 0.844-1.234 1.906-1.234 3.219 0 4.594 2.797 5.625 5.469 5.922-0.344 0.313-0.656 0.844-0.766 1.609-0.688 0.313-2.438 0.844-3.484-1-0.656-1.141-1.844-1.234-1.844-1.234-1.172-0.016-0.078 0.734-0.078 0.734 0.781 0.359 1.328 1.75 1.328 1.75 0.703 2.141 4.047 1.422 4.047 1.422 0 1 0.016 1.937 0.016 2.234 0 0.313-0.219 0.688-0.828 0.578-4.766-1.594-8.203-6.094-8.203-11.391 0-6.625 5.375-12 12-12zM4.547 19.234c0.031-0.063-0.016-0.141-0.109-0.187-0.094-0.031-0.172-0.016-0.203 0.031-0.031 0.063 0.016 0.141 0.109 0.187 0.078 0.047 0.172 0.031 0.203-0.031zM5.031 19.766c0.063-0.047 0.047-0.156-0.031-0.25-0.078-0.078-0.187-0.109-0.25-0.047-0.063 0.047-0.047 0.156 0.031 0.25 0.078 0.078 0.187 0.109 0.25 0.047zM5.5 20.469c0.078-0.063 0.078-0.187 0-0.297-0.063-0.109-0.187-0.156-0.266-0.094-0.078 0.047-0.078 0.172 0 0.281s0.203 0.156 0.266 0.109zM6.156 21.125c0.063-0.063 0.031-0.203-0.063-0.297-0.109-0.109-0.25-0.125-0.313-0.047-0.078 0.063-0.047 0.203 0.063 0.297 0.109 0.109 0.25 0.125 0.313 0.047zM7.047 21.516c0.031-0.094-0.063-0.203-0.203-0.25-0.125-0.031-0.266 0.016-0.297 0.109s0.063 0.203 0.203 0.234c0.125 0.047 0.266 0 0.297-0.094zM8.031 21.594c0-0.109-0.125-0.187-0.266-0.172-0.141 0-0.25 0.078-0.25 0.172 0 0.109 0.109 0.187 0.266 0.172 0.141 0 0.25-0.078 0.25-0.172zM8.937 21.438c-0.016-0.094-0.141-0.156-0.281-0.141-0.141 0.031-0.234 0.125-0.219 0.234 0.016 0.094 0.141 0.156 0.281 0.125s0.234-0.125 0.219-0.219z"></path>
</svg>

</a>
<a id="twitter-link" target="_black"
class="icon" title="twitter" aria-label="twitter"
href="https://twitter.com/kbucktothemax">
<?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 20.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<svg version="1.1" id="White" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 400 400" style="enable-background:new 0 0 400 400;" xml:space="preserve">
<style type="text/css">
	.st0{fill:#FFFFFF;}
</style>
<path class="st0" d="M400,200c0,110.5-89.5,200-200,200S0,310.5,0,200S89.5,0,200,0S400,89.5,400,200z M163.4,305.5
	c88.7,0,137.2-73.5,137.2-137.2c0-2.1,0-4.2-0.1-6.2c9.4-6.8,17.6-15.3,24.1-25c-8.6,3.8-17.9,6.4-27.7,7.6
	c10-6,17.6-15.4,21.2-26.7c-9.3,5.5-19.6,9.5-30.6,11.7c-8.8-9.4-21.3-15.2-35.2-15.2c-26.6,0-48.2,21.6-48.2,48.2
	c0,3.8,0.4,7.5,1.3,11c-40.1-2-75.6-21.2-99.4-50.4c-4.1,7.1-6.5,15.4-6.5,24.2c0,16.7,8.5,31.5,21.5,40.1c-7.9-0.2-15.3-2.4-21.8-6
	c0,0.2,0,0.4,0,0.6c0,23.4,16.6,42.8,38.7,47.3c-4,1.1-8.3,1.7-12.7,1.7c-3.1,0-6.1-0.3-9.1-0.9c6.1,19.2,23.9,33.1,45,33.5
	c-16.5,12.9-37.3,20.6-59.9,20.6c-3.9,0-7.7-0.2-11.5-0.7C110.8,297.5,136.2,305.5,163.4,305.5"/>
</svg>

</a>
</nav>

  
</div>

    <main class="container">
      <header>
  <h1 class="post-title">using python and jinja2 for templating Hashicorp Nomad job files</h1>
</header>
<div class="content">
  <div class="post-meta">
  <span class="post-date">13 Sep 2020</span>
  <span class="post-categories">
    
  </span>
</div>


  <div class="post-body">
    <p>I work on a project that has adopted <a href="https://www.nomadproject.io/">Hashicorp’s Nomad</a> as a job scheduler to orchestrate both Windows-based executables and Docker containers.  Given the need to support mulitple environments, we were faced with duplicating our job files (since at least the <code class="language-plaintext highlighter-rouge">datacenter</code> property needs up dated per environment.  Finding a template language and code to do replacements became important to reduce duplication.</p>

<h3 id="templating-solution">Templating Solution</h3>

<p><a href="https://palletsprojects.com/p/jinja/">Jinja2 templates</a> were a good solution for this given it’s a a mature templating solution and easily implemented with python.  Support for usability outside of web pages, default functions, loops, and conditionals were awesome features we needed.</p>

<h3 id="example-template">Example Template</h3>

<p>This job file does not have a template.  The datacenter property is the first key problem.  Here’s what it looks like without the temp.ate</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>job "login-web-server" {
  datacenters = ["this-is-the-name-of-your-datacenter"]

  group "login-group" {
    task "web-server" {
</code></pre></div></div>

<p>The datacenter property makes it so the job file only can be used for one environment.  but once you have it templated like below, you can just specify it once in the template and built out full files for submission.  For this example, we picked <code class="language-plaintext highlighter-rouge">{$ obj. $}</code> as our templating special characters.  The python gets easier with the <code class="language-plaintext highlighter-rouge">obj</code> part so you can bind an object to the template.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>job "login-web-server" {
  datacenters = ["{$ obj.datacenter $}"]

  group "login-group" {
    task "web-server" {
</code></pre></div></div>

<p><br /></p>

<h3 id="where-is-the-data-coming-from-for-the-template">Where is the data coming from for the template?</h3>

<p>We used json files.  They can be easily read by python into a dictionary and bound to the jinja2 template.  Here’s an example file. Notice the property name is the same as the property after <code class="language-plaintext highlighter-rouge">obj.</code> above.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//data.json</span>
<span class="p">{</span>
    <span class="nl">datacenter</span><span class="p">:</span> <span class="dl">"</span><span class="s2">us-west-1</span><span class="dl">"</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="how-does-the-data-get-bound-to-the-template">How does the data get bound to the template</h3>

<p>The following code loads up your json file, sets up the jinja2 template, and renders.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'data.json'</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s">"job-template.hcl"</span><span class="p">)</span> <span class="k">as</span> <span class="n">template</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">DictLoader</span><span class="p">({</span><span class="n">templateName</span><span class="p">:</span> <span class="n">template</span><span class="p">.</span><span class="n">read</span><span class="p">()}),</span> <span class="n">variable_start_string</span><span class="o">=</span><span class="s">"{$"</span><span class="p">,</span> <span class="n">variable_end_string</span><span class="o">=</span><span class="s">"$}"</span><span class="p">)</span> <span class="c1"># create template loader with our specific variable annotations
</span>    <span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="n">loader</span><span class="o">=</span><span class="n">loader</span><span class="p">)</span>
    <span class="n">job_file_with_data</span> <span class="o">=</span> <span class="n">env</span><span class="p">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">"new_template_name"</span><span class="p">).</span><span class="n">render</span><span class="p">(</span><span class="n">ch</span><span class="o">=</span><span class="n">data</span><span class="p">)</span> <span class="c1"># create the merged job file
</span>
</code></pre></div></div>
<h3 id="schedule-your-process-with-the-new-job-file">Schedule your process with the new job file</h3>

<p>You can now submit the newly created file to your nomad cluster to scheudle your process.  I highly recommend <a href="https://github.com/jrxfive/python-nomad">this library</a> for a nomad client.  It encapsulates the API calls really well.  Submitting a job is as simple as</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">n</span> <span class="o">=</span> <span class="n">nomad</span><span class="p">.</span><span class="n">Nomad</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">"172.16.100.10"</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">n</span><span class="p">.</span><span class="n">job</span><span class="p">.</span><span class="n">register_job</span><span class="p">(</span><span class="s">"job_name"</span><span class="p">,</span> <span class="n">job_file_with_data</span><span class="p">)</span>
</code></pre></div></div>

<hr />
<p><strong>resources:</strong></p>
<ul>
  <li><a href="https://www.nomadproject.io/">https://www.nomadproject.io/</a></li>
  <li><a href="https://palletsprojects.com/p/jinja/">https://palletsprojects.com/p/jinja/</a></li>
  <li><a href="https://pypi.org/project/Jinja2/">https://pypi.org/project/Jinja2/</a></li>
  <li><a href="https://github.com/jrxfive/python-nomad">https://github.com/jrxfive/python-nomad</a></li>
</ul>

    



<div class="post-tags">
  
    <span>
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">hashicorp</span>
    </span>
  
    <span>
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">nomad</span>
    </span>
  
    <span>
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">python</span>
    </span>
  
    <span>
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">jinja2</span>
    </span>
  
</div>
  </div>

  
  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/2020/09/05/setting-up-wife-blog.html">
            using aws, route53, lightsail to setup a wordpress blog
            <small>05 Sep 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/08/27/python-textract-images.html">
            using aws textract to read text from images
            <small>27 Aug 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/08/21/setting-up-blog.html">
            using jekyll, github pages, github actions to setup this blog
            <small>21 Aug 2020</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>

    <!-- Optional footer content -->

  </body>
</html>
